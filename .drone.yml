---
kind: pipeline
name: build-deploy-builder
type: kubernetes

steps:
- name: dev-run-tests-with-coverage
  pull: if-not-exists
  image: node:12.18.4-buster
  commands:
    - yarn
    - yarn build:dependencies
    - yarn test-cov
  when:
    branch:
      - master
    event:
      - push
- name: sonar_scan
  pull: if-not-exists
  image: quay.digital.homeoffice.gov.uk/ukhomeofficedigital/sonar-scanner-node:6a03c77c7e1bad005893cdcc9cd3d99479b79d5c
  commands:
    - sonar-scanner -Dsonar.projectVersion=${DRONE_BUILD_NUMBER} -Dsonar.projectBaseDir=. -Dsonar.projectKey=digital-form-builder
  when:
    branch:
      - master
    event:
      - push
  depends_on:
    - dev-run-tests-with-coverage
- name: check-designer-version
  pull: if-not-exists
  image: node:12.18.4-buster
  commands:
    - export DESIGNER_TAG_VERSION=$(node -e "console.log(require('./designer/package.json').version);")
    - echo $DESIGNER_TAG_VERSION
- name: dev-build-image-designer
  pull: if-not-exists
  image: docker:lastest
  commands:
    - docker build .
    - echo "- echo "digital-form-builder-runner:$DESIGNER_TAG_VERSION"
    - docker -t digital-form-builder-designer:$DESIGNER_TAG_VERSION
  when:
    branch:
      - master
    event:
      - push
  depends_on:
    - check-designer-version
- name: check-runner-version
  pull: if-not-exists
  image: node:12.18.4-buster
  commands:
    - RUNNER_TAG_VERSION=$(node -e "console.log(require('./runner/package.json').version);")
    - echo $RUNNER_TAG_VERSION
  when:
    branch:
      - master
    event:
      - push
  depends_on:
    - sonar_scan
- name: dev-build-image-runner
  pull: if-not-exists
  image: docker:latest
  commands:
    - docker build .
    - echo "digital-form-builder-runner:$RUNNER_TAG_VERSION"
    - docker -t "digital-form-builder-runner:$RUNNER_TAG_VERSION"
  when:
    branch:
      - master
    event:
      - push
  depends_on:
    - check-runner-version
- name: dev-deploy-designer
  pull: if-not-exists
  image: node:12.18.4-buster
  commands:
    - echo "deploy designer"
  depends_on:
    - dev-build-image-designer
- name: dev-deploy-runner
  pull: if-not-exists
  image: node:12.18.4-buster
  commands:
    - echo "deploy runner"
  depends_on:
    - dev-build-image-runner
- name: dev-smoke-tests
  pull: if-not-exists
  image: node:12.18.4-buster
  commands:
    - echo  "Smoke tests"
  depends_on:
    - dev-deploy-designer
    - dev-deploy-runner
